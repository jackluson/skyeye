<!DOCTYPE html>

<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>天眼舆情监测系统</title>
	<link rel="stylesheet" type="text/css" href="css/app.css" />
</head>

<body>
	<header id="header">
		<h3 class="header-title">天眼舆情监测系统</h3>
		<div class="header-info header-info-l">数据来源：互联网</div>
		<div class="header-info header-info-r">数据日期：<span id="nowDate"></span></div>
	</header>

	<footer id="footer"></footer>

	<div id="container">
		<div id="flexCon">
			<div class="flex-row">
				<div class="flex-cell flex-cell-l">
					<div class="chart-wrapper">
						<h3 class="chart-title">关键词词云</h3>
						<div class="chart-div" id="wordChart">
							<div class="chart-loader">
								<div class="loader"></div>
							</div>
						</div>
					</div>
				</div>
				<div class="flex-cell flex-cell-c" style="padding-right:0;">
					<div class="chart-wrapper">
						<h3 class="chart-title">统计数据</h3>
						<div class="chart-div chart-done">
							<table class="data-t">
								<tr>
									<th><img src="img/icon-02.png" /></th>
									<td>
										<p><span id="listedSecurity">0</span></p>
										<p>采集舆论文章数</p>
									</td>
									<th><img src="img/icon-stage.png" /></th>
									<td>
										<p><span id="totalMarket">0</span></p>
										<p>有效数据信息采集平台数</p>
									</td>
								</tr>
								<tr>

									<th><img src="img/icon-01.png" /></th>
									<td>
										<p><span id="listedCompany">0</span></p>
										<p>最新教育公司数</p>
									</td>
									<th><img src="img/icon-04.png" /></th>
									<td>

										<p><span id="circulationMarket">0</span></p>
										<p>教育市场规模(亿元)</p>
									</td>
								</tr>
								<!-- <tr>
									<th><img src="img/icon-05.png" /></th>
									<td>
										<p><span id="shRatio">0</span></p>
										<p>上市平均市盈率</p>
									</td>
									<th><img src="img/icon-06.png" /></th>
									<td>
										<p><span id="szRatio">0</span></p>
										<p>深市平均市盈率</p>
									</td>
								</tr> -->
							</table>
						</div>
					</div>
				</div>
				<div class="flex-cell flex-cell-r" style="padding-left:0;">
					<div class="chart-wrapper">
						<h3 class="chart-title">舆论地域分布</h3>
						<div class="chart-div" id="mapChart">
							<div class="chart-loader">
								<div class="loader"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="flex-row">
				<div class="flex-cell flex-cell-lc" style="padding-bottom:0;">
					<div class="chart-wrapper">
						<h3 class="chart-title">热度走势图</h3>
						<div class="chart-div" id="trendChart">
							<div class="chart-loader">
								<div class="loader"></div>
							</div>
						</div>
					</div>
				</div>
				<div class="flex-cell flex-cell-r" style="padding-bottom:0;">
					<div id="sector">
						<p class="title" v-cloak><span v-for="(item,index) in tabList"
								@click="handleTabChange(index)">{{item}}</span></p>
						<div class=" chart-wrapper">
							<h3 class="chart-title" v-cloak>{{tabList[activeIndex]}}分析图</h3>
							<div class="chart-div" id="csrcChart">
								<div class="chart-loader">
									<div class="loader"></div>
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
	<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
	<script type="text/javascript" src="js/countUp.min.js"></script>
	<script type="text/javascript" src="js/echarts.min.js"></script>
	<script type="text/javascript" src="js/echarts-wordcloud.min.js"></script>
	<script type="text/javascript" src="js/echarts-map-china.js"></script>
	<script type="text/javascript" src="js/echarts-theme-shine.js"></script>
	<script type="text/javascript">
		$(function () {
			//获取当天日期
			(function () {
				const now = new Date();
				const year = now.getFullYear();
				const month = now.getMonth() + 1;
				const day = now.getDate();
				$("#nowDate").html(year + "年" + month + "月" + day + "日");
			})();

			//获取统计数据
			$.ajax({
				url: "data/count-data.json",
				dataType: "json"
			}).done(function (data) {
				//console.log('Data: ', data);
				rollNum("listedCompany", 0, data.listed_companies_total);
				rollNum("listedSecurity", 0, data.listed_securities_total);
				rollNum("totalMarket", 0, data.total_market_value, 2);
				rollNum("circulationMarket", 0, data.circulation_market_value, 2);
				rollNum("shRatio", 0, data.sh_pe_ratio, 2);
				rollNum("szRatio", 0, data.sz_pe_ratio, 2);
			}).fail(function (jqXHR, textStatus) {
				console.log("Ajax Error: ", textStatus);
			});

			/*************** 词云 **************/
			//https://github.com/ecomfe/echarts-wordcloud
			//初始化echarts实例
			const wordChart = echarts.init(document.getElementById("wordChart"));
			const wordOpt = {
				series: [{
					type: 'wordCloud',
					shape: 'circle', //circle cardioid diamond triangle-forward triangle
					left: -100,
					right: -100,
					top: 0,
					right: 0,
					width: '150%',
					height: '100%',
					gridSize: 8, //值越大，word间的距离越大，单位像素
					sizeRange: [10, 32], //word的字体大小区间，单位像素
					rotationRange: [-90, 90], //word的可旋转角度区间
					textStyle: {
						normal: {
							color: function () {
								return 'rgb(' + [
									Math.round(Math.random() * 160),
									Math.round(Math.random() * 160),
									Math.round(Math.random() * 160)
								].join(',') + ')';
							}
						},
						emphasis: {
							shadowBlur: 2,
							shadowColor: '#000'
						}
					},
					data: [{
						name: '在线教育',
						value: 3000,
						textStyle: {
							normal: { color: '#f52f55' },
							emphasis: {}
						}
					}, {
						name: '学习',
						value: 2181
					}, {
						name: '作业',
						value: 1386
					}, {
						name: '大学',
						value: 2055
					}, {
						name: '英文',
						value: 2467
					}, {
						name: '资料',
						value: 2244
					}, {
						name: '网课',
						value: 1898
					}, {
						name: '老师',
						value: 1484
					}, {
						name: '少儿',
						value: 3865
					}, {
						name: '微信',
						value: 897
					}, {
						name: '互联网',
						value: 847
					}, {
						name: '数学',
						value: 1366
					}, {
						name: '视频',
						value: 555
					}, {
						name: '入门',
						value: 550
					}, {
						name: '互联网+',
						value: 2222
					}, {
						name: '课程',
						value: 366
					}, {
						name: '改作业',
						value: 360
					}, {
						name: '英语',
						value: 282
					}, {
						name: '高等教育',
						value: 273
					}, {
						name: '直播课',
						value: 265
					}]
				}],
				backgroundColor: 'rgba(255, 255, 255, 0.9)'
			};
			wordChart.setOption(wordOpt);
			//获取地域分布数据
			const mapChart = echarts.init(document.getElementById("mapChart"), "shine");
			const mapChartOpt = {
				tooltip: {
					formatter: function (params) {
						const data = params.data;
						return data.name + "<br />舆论文章数：" + data.value;
					}
				},
				visualMap: {
					type: "piecewise",
					splitNumber: 6,
					itemWidth: 10,
					itemHeight: 10,
					itemGap: 5,
					textGap: 5,
					textStyle: {
						fontSize: 10,
						color: "#b0c2f9"
					},
					min: 0,
					max: 600,
					calculable: true,
					seriesIndex: [0]
				},
				geo: {
					map: "china",
					roam: true, //开启鼠标缩放和漫游
					zoom: 1, //地图缩放级别
					selectedMode: "single",
					top: 10,
					bottom: 10,
					layoutCenter: ["50%", "50%"],
					//layoutSize: "100%", //保持地图宽高比
					label: {
						show: true,
						fontSize: 10,
						color: "#ceac09"
					}
				},
				series: [{
					name: "地域分布",
					type: "map",
					geoIndex: 0
				}]
			};
			mapChart.setOption(mapChartOpt);
			$.ajax({
				url: "data/region-count.json",
				dataType: "json"
			}).done(function () {
				$("#mapChart").addClass("chart-done");
			}).done(function (data) {
				//console.log('Data: ', data);
				const chartData = [];
				for (let i in data) {
					chartData.push({
						name: data[i].region,
						value: data[i].count
					});
				}
				mapChart.setOption({
					series: [{
						name: "地域分布",
						data: chartData
					}]
				});
			}).fail(function (jqXHR) {
				console.log("Ajax Fail: ", jqXHR.status, jqXHR.statusText);
			});

			//获取月度文章情况数据
			const trendChart = echarts.init(document.getElementById("trendChart"), "shine");
			const trendChartOpt = {
				tooltip: {
					trigger: "axis",
					axisPointer: {
						type: 'cross',
						crossStyle: {
							color: '#999'
						}
					}
				},
				toolbox: {
					feature: {
						dataView: { show: true, readOnly: false },
						magicType: { show: true, type: ['line', 'bar'] },
						restore: { show: true },
						saveAsImage: { show: true }
					}
				},
				legend: {
					left: "center",
					bottom: 3,
					itemWidth: 15,
					itemHeight: 10,
					textStyle: {
						fontSize: 12,
						color: "#b0c2f9"
					},
					data: ["积极", "消极", "中性", "文章总数"]
				},
				grid: {
					top: 40,
					bottom: 50,
					left: 60,
					right: 60
				},
				xAxis: {
					type: "category",
					axisLine: {
						lineStyle: { color: "#b0c2f9" }
					},
					axisTick: { show: false },
					axisLabel: {
						fontSize: 12,
						color: "#b0c2f9"
					}
				},
				yAxis: [{
					name: "文章数量/篇",
					type: "value",
					splitNumber: 5,
					axisLine: {
						lineStyle: { color: "#b0c2f9" }
					},
					splitLine: { show: false },
					axisTick: { color: "#b0c2f9" },
					axisLabel: {
						fontSize: 12,
						color: "#b0c2f9",
						formatter: (value, index) => {
							return parseInt(value / 10000) + "千篇";
						}
					}
				}],
				// visualMap: {
				// 	show: false,
				// 	seriesIndex: 2,
				// 	dimension: 0,
				// 	pieces: [{
				// 		lte: 9,
				// 		color: "rgba(176, 58, 91, 1)"
				// 	}, {
				// 		gt: 9,
				// 		lte: 11,
				// 		color: "rgba(176, 58, 91, 0.5)"
				// 	}]
				// },
				series: []
			};
			trendChart.setOption(trendChartOpt);
			$.ajax({
				url: "data/month-count.json",
				dataType: "json"
			}).done(function () {
				$("#trendChart").addClass("chart-done");
			}).done(function (data) {
				//console.log('Data: ', data);
				const xData = [];
				const yData1 = [];
				const yData2 = [];
				const yData3 = [];
				const yData4 = [];
				for (let i in data) {
					xData.push(data[i].month);
					const { sh_market_capitalization, sh_transaction_amount, sh_pe_ratio } = data[i]
					yData1.push(sh_market_capitalization.toFixed(0));
					yData2.push(sh_transaction_amount.toFixed(0));
					yData3.push(sh_pe_ratio.toFixed(0) * 1000);
					const sum = sh_market_capitalization + sh_transaction_amount + sh_pe_ratio
					yData4.push(sum.toFixed(0))
				}
				trendChart.setOption({
					xAxis: {
						data: xData,
					},
					series: [{
						name: "积极",
						type: 'bar',
						data: yData1
					}, {
						name: "消极",
						type: 'bar',
						data: yData2
					}, , {
						name: "中性",
						type: 'bar',
						data: yData3
					}, {
						name: "总数",
						type: 'line',
						data: yData4
					}]
				});
			}).fail(function (jqXHR) {
				console.log("Ajax Fail: ", jqXHR.status, jqXHR.statusText);
			});

			var data = {
				tabList: ['采集平台', '人群', '性别', '信息属性'],
				activeIndex: 0,
				csrcChart: null,
			}
			var vm = new Vue({
				el: '#sector',
				data: function () {
					return data;
				},
				mounted() {
					//获取信息采集平台数据
					this.csrcChart = echarts.init(document.getElementById("csrcChart"), "shine");
					const csrcChartOpt = {
						tooltip: {
							trigger: "item",
							formatter: "{b0}<br />文章数：{c0}<br />占比：{d0}%"
						},
						legend: {
							type: "scroll",
							orient: "vertical",
							padding: 0,
							top: 15,
							right: 0,
							itemGap: 5,
							itemWidth: 10,
							itemHeight: 10,
							textStyle: {
								fontSize: 10,
								color: "#b0c2f9"
							}
						},
						series: [{
							name: "采集平台比例",
							type: "pie",
							center: ["47%", "55%"],
							radius: ["30%", "85%"]
						}]
					};
					this.csrcChart.setOption(csrcChartOpt);
					this.fetchData();

				},
				methods: {
					handleTabChange(index) {
						this.activeIndex = index;
						console.log(`: -------------------------------`);
						console.log(`handleTabChange -> index`, index);
						console.log(`: -------------------------------`);
					},
					fetchData() {
						$.ajax({
							url: "data/csrc-industry.json",
							dataType: "json"
						}).done(() => {
							$("#csrcChart").addClass("chart-done");
						}).done((data) => {
							//console.log('Data: ', data);
							const chartData = [];
							for (let i in data) {
								chartData.push({
									name: data[i].alias,
									value: data[i].stock
								});
							}
							this.csrcChart.setOption({
								series: [{
									name: "",
									data: chartData
								}]
							});
						}).fail(function (jqXHR) {
							console.log("Ajax Fail: ", jqXHR.status, jqXHR.statusText);
						});

						$.ajax({
							url: "http://192.168.90.177:8080/v1/opinion/personType",
							dataType: "json"
						}).done(function () {
							$("#csrcChart").addClass("chart-done");
						}).done((data) => {
							console.log(`fetchData -> data`, data);
							console.log(`: -----------------------`);

						})
					}


				},
			})

			//浏览器窗口大小变化时，重置报表大小
			$(window).resize(function () {
				wordChart.resize();
				mapChart.resize();
				trendChart.resize();
			});
		});

		//数字变化特效
		function rollNum(elId, startVal, endVal, decimalNum) {
			let n = decimalNum || 0;
			let countUp = new CountUp(elId, startVal, endVal, n, 2.5, {
				useEasing: true,
				useGrouping: true,
				separator: ',',
				decimal: '.'
			});
			if (!countUp.error) {
				countUp.start();
			} else {
				console.error(countUp.error);
			}
		}
	</script>
</body>

</html>